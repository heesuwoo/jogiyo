<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name = "viewport" content = "width=device-width", initial-scale = "1">	<!-- 반응형 웹에 사용하는 메타탭(부트스트랩) -->
        <link rel="stylesheet" href="/css/bootstrap.css"> <!-- 스타일시트 참조, 부트스트랩 참조 -->
        <link rel="stylesheet" href="/css/jquery-ui.min.css" />
        <link rel="stylesheet" href="/css/style.css" />

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Sunflower:wght@500&display=swap" rel="stylesheet">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">

        <title>조기요 - 사장님 사이트</title>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
        <script type="text/javascript" src="/js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/js/drop_menu.js"></script>

        style.

                .navbar-brand{
                    font-family: 'Do Hyeon', sans-serif;
                    font-size: 25px;
                }
                nav{
                    font-family: 'Do Hyeon', sans-serif;
                    font-size: 18px;
                }

                .head_title{
                    font-family: 'Sunflower', sans-serif;
                    font-size: 30px;
                }

                body{
                    font-family: 'Gowun Dodum', sans-serif;
                }


                .container {
                    margin-top:3%;
                    padding-top:20px;
                    border: solid 2px black;
                    background: none repeat scroll 0 0 #ffffff;
                    border-radius: 80px; /*메뉴 테두리 */
                    color: #444444;
                    box-shadow: 1px 1px 3px 1px rgba(0, 0, 0, 0.14);
                }
                .btnst{
                    padding: 5% 5% 5% 5%;
                }
                .center{
                    position:relative;
                    left: 10%;
                    right: 10%;
                    text-align: center;
                }
                .button {
                    cursor: pointer;
                    -webkit-transition-duration: 0.4s; /* Safari */
                    transition-duration: 0.4s;
                }
        
    </head>
    //- body(onload=`test(${JSON.stringify(arr1)})`)    //router.get("/menusetting"
    body
        <nav class ="navbar navbar-default">	<!-- 내비게이션 구현 -->
            <div class = "navbar-header">	<!-- 헤더(로고 영역) -->
                <button type="button" class="navbar-toggle collapsed" data-toggle = "collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded = "false">	<!-- 버튼 -->
                    <span class = "icon-bar"></span>	<!-- 네비게이션 목록 작대기 -->
                    <span class = "icon-bar"></span>	
                    <span class = "icon-bar"></span>
                </button> 
                <a class = "navbar-brand" href="main"> 조기요-사장님 사이트 </a> <!-- brand: 로고 -->
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class ="nav navbar-nav">	<!-- 리스트 -->
                    <li><a href="javascript:movePage('main')">메인 페이지</a></li>
                    <li><a href="javascript:movePage('orders')">주문접수</a></li>
                    <li class="active"><a href="javascript:movePage('management')">매장관리</a></li>	<!-- ## -->
                </ul>
                <ul class ="nav navbar-nav navbar-right">	<!-- 오른쪽 리스트 -->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> 접속하기 <span class="caret"></span></a>
                        <ul class= "dropdown-menu">
                            //- 로그인 여부 확인 후 드롭다운
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        
    <h3 class="head_title"> ▶ 메뉴 설정</h3>

    <div class="container" style= "background-color: #f1f7da;">
        <form name="f" method="post">
 
            <div class="col-sm-12 pt-3 center">
                <div class="card" style= "background-color: #f1f7da;">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title" style="font-weight: bolder;"><i class="fas fa-square"></i> 메뉴 등록 </h4>
                        <p class="card-catagory"></p>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" style = "border-collapse: separate;">
                                <tbody>
                                <tr>
                                    //- <td>대표자 성함</td>
                                    //- <td>
                                    //-     <input type="text" name="admin_id" class="form-control" placeholder="성함을 입력해주세요.">
                                    //- </td>
                                    <td>메뉴 이름</td>
                                    <td>
                                        <input type="text" id="inputTitle" class="form-control" placeholder="메뉴 이름을 적어주세요.">
                                    </td>                        
                                </tr>
                                <tr>
                                    <td>매뉴 가격</td>
                                    <td>
                                        <input type="text" id="inputPrice" class="form-control" placeholder="메뉴 가격을 적어주세요(숫자만 작성).">                                    
                                    </td>
                                </tr>    
                                <tr>
                                    <td>매뉴에 관한 설명</td>
                                    <td>
                                        <input type="text" id="inputText" class="form-control" placeholder="메뉴에 관한 설명을 적어주세요.">                                    
                                    </td>
                                </tr>    
                                
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    
                <div class="pt-3"></div>
    
                <div class="card" style= "background-color: #f1f7da;">
                    <h4 class="card-header"><i class="fas fa-square"></i> 메뉴 이미지 등록</h4>
                    <div class="card-body">
                        <table class="table">
                            <tbody>
                                <tr style="line-height:32px;">
                                    <td colspan="2" style = "font-weight: bolder;"><span style = "background-color: #f9d423;">★반드시 PNG 이미지로 첨부해주세요★</span></td>
                                </tr>
                                <tr style="line-height:32px;">
                                    <td>PNG 이미지 첨부</td>
                                    <td>
                                        <input type="file" id="inputFile" class="form-control text-right">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
    
            </div>
            </form>
        
            <div class="text-center mt-3 btnst">
                <button type="button" onclick="submitMenu()" class="btn btn-success">메뉴 등록</button>
            </div>
        </div>
        <div class="container" style= "background-color: #FFFFF3;">
            <div class="col-sm-12 pt-3 center">
                <div class="card" style= "background-color: #FFFFF3;">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title" style="font-weight: bolder;"><i class="fas fa-square"></i> 등록된 메뉴 정보 </h4>
                        <p class="card-catagory"></p>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" style = "border-collapse: separate;">
                                <thead>
                                <tr>
                                    <td id="menu_td">
                                    <h5>메뉴 사진</h5>
                                    </td>
                                    <td id="menu_td">
                                        <h5>메뉴 이름</h5>
                                    </td>
                                    <td id="menu_td">
                                        <h5>가격</h6>
                                    </td>
                                    <td id="menu_td">
                                        <h5>설명</h5>
                                    </td>
                                    
                                    <td id="menu_td">
                                        <h5>삭제</h5>
                                    </td>              
                                </tr>
                                </thead>
                                <tbody id="menu_table">
                                </tbody>
                            </table>
                        </div>
                    </div>         
                </div>
            </div>
        </div>
	
    script.
        
        drop_menu();

         const reqBody = {
                cookie : getCookie("id")
        }

        const xhr = new XMLHttpRequest()
        xhr.onload = () => {
            const result = JSON.parse(xhr.responseText)
            
            var menu_list = result.menu
            //- console.log(result)
            list_show(menu_list);
        }

        xhr.open('POST', '/menusetting_select')
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(JSON.stringify(reqBody))


        //메뉴 리스트 보여줌
        function list_show(list){
            for(var i = 0; i<list.length; i++){

                const table = document.querySelector("#menu_table");
                var menu_item = document.createElement('tr')

                var img = 'data:image/png;base64,'+ list[i].img

                //- console.log(img)
                var title = list[i].title
                var price = list[i].price
                var ex = list[i].ex
                
                var id = "item_" +i
                menu_item.id = id;

                var inner1 = `<td id="menu_td"> <img src = "${img}" id="menu_img" /> </td>`
                var inner2 = `<td id="tilte"> ${title} </td>`
                var inner3 = `<td id="menu_td">${price} </td>`
                var inner4 = `<td id="menu_td">${ex} </td>`
                var inner5 = `<td> <button type="button" id="add" class="btn btn-danger form-control" onclick="delete_menu(this,'${title}')">제거 </button> </td>`
                menu_item.innerHTML = inner1 + inner2 + inner3 + inner4 + inner5

                table.appendChild(menu_item);
            }
        }

        //메뉴 등록
        function submitMenu() {
            const file = document.querySelector("#inputFile");
            const title = document.querySelector("#inputTitle");
            const price = document.querySelector("#inputPrice");
            const ex = document.querySelector("#inputText");

            const reader = new FileReader();    //1

            if(file != null && title != null && price != null && ex != null){

                reader.onload = () => { //3
                var strImg = reader.result;
                var menu_title = title.value;
                var menu_price = price.value;
                var menu_ex = ex.value;
                //- console.log("title.pug", strImg)

                const payload = {
                    cookie : getCookie("id"),
                    img_base64: strImg,
                    menu_title: menu_title,
                    menu_price : menu_price,
                    menu_ex: menu_ex
                };

                const xhr = new XMLHttpRequest();

                xhr.onload = () => {    //4
                    const result = JSON.parse(xhr.responseText)
                    if (result.code == 1) {
                    // 끝
                        //- console.log(result.menu);
                        alert("메뉴가 등록되었습니다.")
                        add_menu(strImg, menu_title,menu_price,menu_ex);
                    }else{
                        alert("메뉴 등록 error")
                    }
                };

                xhr.open("POST", "/menusetting");
                xhr.setRequestHeader('Content-Type', 'application/json')
                xhr.send(JSON.stringify(payload));
            };

                reader.readAsDataURL(file.files[0]);   //2
            } else{
                alert("사진 첨부와 빈칸을 모두 입력해주세요.")
            }
        }

        //- 메뉴 추가시 테이블에 보임
        function add_menu(strImg, menu_title,menu_price,menu_ex){
            
            //- var img = 'data:image/png;base64,' + strImg
            //- console.log(strImg)
            var menu = document.querySelector("#menu_table");
            var menu_insert = document.createElement('tr')
            
            var inner1 = `<td id="menu_td"> <img src = "${strImg}" id="menu_img" /> </td>`
            var inner2 = `<td id="tilte"> ${menu_title} </td>`
            var inner3 = `<td id="menu_td">${menu_price} </td>`
            var inner4 = `<td id="menu_td">${menu_ex} </td>`
            var inner5 = `<td> <button type="button" id="add" class="btn btn-danger form-control" onclick="delete_menu(this, '${menu_title}' )">제거 </button> </td>`
            menu_insert.innerHTML = inner1 + inner2 + inner3 + inner4 + inner5

            menu.appendChild(menu_insert);
        }
        
        //- 메뉴 삭제시 테이블, db에서 사라짐
        function delete_menu(td, title_item){
            var menu = document.querySelector("#menu_table");
            var tr = td.parentNode.parentNode
            //- console.log(tr)

            const reqBody = {
                cookie : getCookie("id"),
                title: title_item
            }

            const xhr = new XMLHttpRequest()

            xhr.onload = () => {
                const result = JSON.parse(xhr.responseText)

                //- console.log("**", result.code);
                
                if(result.code == 1){
                    menu.removeChild(tr)
                    alert("메뉴가 삭제되었습니다.")
                }else{
                    alert("메뉴 삭제 오류")
                }
            }
            xhr.open('POST', '/menusetting_delete')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.send(JSON.stringify(reqBody))
        }

</body>
</html>